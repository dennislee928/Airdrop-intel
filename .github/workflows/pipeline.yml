name: Airdrop Intel Pipeline

on:
  schedule:
    - cron: "0 * * * *"   # ÊØèÂ∞èÊôÇÂü∑Ë°å‰∏ÄÊ¨°
  workflow_dispatch:       # ÂÖÅË®±ÊâãÂãïËß∏Áôº

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # ÂÆâË£ù jq Áî®Êñº JSON ËôïÁêÜ
          sudo apt-get update && sudo apt-get install -y jq

      - name: Run pipeline
        env:
          CMC_API_KEY: ${{ secrets.CMC_API_KEY }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python scripts/fetch_sources.py
          python scripts/check_wallets.py
          python scripts/aggregate.py
          python scripts/notify_github.py
          python scripts/notify_discord.py

      - name: Send mini-report to Discord
        if: env.DISCORD_WEBHOOK_URL != '' && always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # Ê™¢Êü•Ê™îÊ°àÊòØÂê¶Â≠òÂú®
          if [ ! -f "output/events_sources.json" ]; then
            echo "events_sources.json not found, skipping Discord report"
            exit 0
          fi

          PIPELINE_TIME="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

          # Áµ±Ë®à‰∫ã‰ª∂Á∏ΩÊï∏
          NUM_EVENTS=$(jq '. | length' output/events_sources.json 2>/dev/null || echo "0")

          # ÊåâÁãÄÊÖãÁµ±Ë®à
          NUM_ACTIVE=$(jq '[.[] | select(.status == "active")] | length' output/events_sources.json 2>/dev/null || echo "0")
          NUM_UPCOMING=$(jq '[.[] | select(.status == "upcoming")] | length' output/events_sources.json 2>/dev/null || echo "0")
          NUM_ENDED=$(jq '[.[] | select(.status == "ended")] | length' output/events_sources.json 2>/dev/null || echo "0")
          NUM_POTENTIAL=$(jq '[.[] | select(.status == "potential")] | length' output/events_sources.json 2>/dev/null || echo "0")

          # Êåâ‰æÜÊ∫êÁµ±Ë®à
          NUM_AIRDROP_IO=$(jq '[.[] | select(.source == "airdrops_io")] | length' output/events_sources.json 2>/dev/null || echo "0")
          NUM_CMC=$(jq '[.[] | select(.source == "cmc_airdrops")] | length' output/events_sources.json 2>/dev/null || echo "0")
          NUM_ICOMARKS=$(jq '[.[] | select(.source == "icomarks_airdrops")] | length' output/events_sources.json 2>/dev/null || echo "0")
          NUM_ALTCOIN=$(jq '[.[] | select(.source == "altcointrading_airdrops")] | length' output/events_sources.json 2>/dev/null || echo "0")
          NUM_CHECKLIST=$(jq '[.[] | select(.source == "airdrop_checklist")] | length' output/events_sources.json 2>/dev/null || echo "0")
          NUM_ALERT=$(jq '[.[] | select(.source == "airdropsalert")] | length' output/events_sources.json 2>/dev/null || echo "0")

          # Áµ±Ë®àÈå¢ÂåÖ
          NUM_WALLETS=$(jq '. | length' output/wallets_report.json 2>/dev/null || echo "0")
          WALLETS_WITH_ACTIVITY=$(jq '[.[] | select(.has_defi_activity == true)] | length' output/wallets_report.json 2>/dev/null || echo "0")
          TOTAL_TX=$(jq '[.[] | .tx_count] | add' output/wallets_report.json 2>/dev/null || echo "0")

          # Áµ±Ë®à Alerts
          NUM_ALERTS=$(jq '. | length' output/alerts.json 2>/dev/null || echo "0")
          NUM_HIGH_ALERTS=$(jq '[.[] | select(.priority == "high")] | length' output/alerts.json 2>/dev/null || echo "0")
          NUM_MEDIUM_ALERTS=$(jq '[.[] | select(.priority == "medium")] | length' output/alerts.json 2>/dev/null || echo "0")
          NUM_LOW_ALERTS=$(jq '[.[] | select(.priority == "low")] | length' output/alerts.json 2>/dev/null || echo "0")

          # ÂèñÂæóÂâç 3 ÂÄãÈ´òÂÑ™ÂÖàÁ¥ö alerts ÁöÑÂ∞àÊ°àÂêçÁ®±
          TOP_ALERTS=$(jq -r '[.[] | select(.priority == "high") | .project] | .[0:3] | join(", ")' output/alerts.json 2>/dev/null || echo "None")
          if [ "$TOP_ALERTS" = "" ]; then
            TOP_ALERTS="None"
          fi

          # ÂèñÂæóÂâç 5 ÂÄã active Á©∫ÊäïÁöÑÂ∞àÊ°àÂêçÁ®±ÔºàÂéªÈáçÔºâ
          TOP_ACTIVE=$(jq -r '[.[] | select(.status == "active") | .project] | unique | .[0:5] | join(", ")' output/events_sources.json 2>/dev/null || echo "None")
          if [ "$TOP_ACTIVE" = "" ]; then
            TOP_ACTIVE="None"
          fi

          # ÂèñÂæóÂâç 3 ÂÄã upcoming Á©∫ÊäïÁöÑÂ∞àÊ°àÂêçÁ®±
          TOP_UPCOMING=$(jq -r '[.[] | select(.status == "upcoming") | .project] | unique | .[0:3] | join(", ")' output/events_sources.json 2>/dev/null || echo "None")
          if [ "$TOP_UPCOMING" = "" ]; then
            TOP_UPCOMING="None"
          fi

          # Âª∫Á´ã Discord Ë®äÊÅØÔºà‰ΩøÁî® Markdown Ê†ºÂºèÔºâ
          MESSAGE="‚úÖ **Airdrop Intel Pipeline Report**

          üìÖ **Execution Time:** \`$PIPELINE_TIME\` UTC

          üìä **Events Summary:**
          ‚Ä¢ **Total Events:** \`$NUM_EVENTS\`
          ‚Ä¢ Active: \`$NUM_ACTIVE\` | Upcoming: \`$NUM_UPCOMING\` | Ended: \`$NUM_ENDED\` | Potential: \`$NUM_POTENTIAL\`

          üîç **By Source:**
          ‚Ä¢ Airdrops.io: \`$NUM_AIRDROP_IO\`
          ‚Ä¢ CoinMarketCap: \`$NUM_CMC\`
          ‚Ä¢ ICOMarks: \`$NUM_ICOMARKS\`
          ‚Ä¢ AltcoinTrading: \`$NUM_ALTCOIN\`
          ‚Ä¢ Airdrop Checklist: \`$NUM_CHECKLIST\`
          ‚Ä¢ AirdropsAlert: \`$NUM_ALERT\`

          üíº **Wallets Analyzed:**
          ‚Ä¢ Checked: \`$NUM_WALLETS\`
          ‚Ä¢ With DeFi Activity: \`$WALLETS_WITH_ACTIVITY\`
          ‚Ä¢ Total TX Count: \`$TOTAL_TX\`

          üö® **Alerts Generated:**
          ‚Ä¢ Total: **\`$NUM_ALERTS\`**
          ‚Ä¢ High: **\`$NUM_HIGH_ALERTS\`** | Medium: \`$NUM_MEDIUM_ALERTS\` | Low: \`$NUM_LOW_ALERTS\`
          ‚Ä¢ Top High Priority: $TOP_ALERTS

          üéØ **Top Active Airdrops:**
          $TOP_ACTIVE

          üîÆ **Upcoming Airdrops:**
          $TOP_UPCOMING

          üìé Full details available in GitHub Actions artifacts."

          # ‰ΩøÁî® jq Ê≠£Á¢∫ËΩâÁæ© JSON Â≠ó‰∏≤
          ESCAPED_MESSAGE=$(echo "$MESSAGE" | jq -Rs .)

          # ÁôºÈÄÅÂà∞ Discord
          curl -s -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\": $ESCAPED_MESSAGE}" \
            "$DISCORD_WEBHOOK_URL" || echo "Failed to send Discord message"

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-reports
          path: output/
          retention-days: 7
