name: Airdrop Intel Pipeline

on:
  schedule:
    - cron: "0 * * * *"   # æ¯å°æ™‚åŸ·è¡Œä¸€æ¬¡
  workflow_dispatch:       # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # å®‰è£ jq ç”¨æ–¼ JSON è™•ç†
          sudo apt-get update && sudo apt-get install -y jq

      - name: Run pipeline
        env:
          CMC_API_KEY: ${{ secrets.CMC_API_KEY }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python scripts/fetch_sources.py
          python scripts/check_wallets.py
          python scripts/aggregate.py
          python scripts/notify_github.py
          python scripts/notify_discord.py

      - name: Send mini-report to Discord
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨
          if [ ! -f "output/events_sources.json" ]; then
            echo "events_sources.json not found, skipping Discord report"
            exit 0
          fi

          # æª¢æŸ¥ webhook URL
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "DISCORD_WEBHOOK_URL not set, skipping Discord report"
            exit 0
          fi

          PIPELINE_TIME="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

          # çµ±è¨ˆäº‹ä»¶ç¸½æ•¸
          NUM_EVENTS=$(jq '. | length' output/events_sources.json 2>/dev/null || echo "0")

          # æŒ‰ç‹€æ…‹çµ±è¨ˆ
          NUM_ACTIVE=$(jq '[.[] | select(.status == "active")] | length' output/events_sources.json 2>/dev/null || echo "0")
          NUM_UPCOMING=$(jq '[.[] | select(.status == "upcoming")] | length' output/events_sources.json 2>/dev/null || echo "0")
          NUM_ENDED=$(jq '[.[] | select(.status == "ended")] | length' output/events_sources.json 2>/dev/null || echo "0")
          NUM_POTENTIAL=$(jq '[.[] | select(.status == "potential")] | length' output/events_sources.json 2>/dev/null || echo "0")

          # æŒ‰ä¾†æºçµ±è¨ˆ
          NUM_AIRDROP_IO=$(jq '[.[] | select(.source == "airdrops_io")] | length' output/events_sources.json 2>/dev/null || echo "0")
          NUM_CMC=$(jq '[.[] | select(.source == "cmc_airdrops")] | length' output/events_sources.json 2>/dev/null || echo "0")
          NUM_ICOMARKS=$(jq '[.[] | select(.source == "icomarks_airdrops")] | length' output/events_sources.json 2>/dev/null || echo "0")
          NUM_ALTCOIN=$(jq '[.[] | select(.source == "altcointrading_airdrops")] | length' output/events_sources.json 2>/dev/null || echo "0")
          NUM_CHECKLIST=$(jq '[.[] | select(.source == "airdrop_checklist")] | length' output/events_sources.json 2>/dev/null || echo "0")
          NUM_ALERT=$(jq '[.[] | select(.source == "airdropsalert")] | length' output/events_sources.json 2>/dev/null || echo "0")

          # çµ±è¨ˆéŒ¢åŒ…ï¼ˆæª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨ï¼‰
          if [ -f "output/wallets_report.json" ]; then
            NUM_WALLETS=$(jq '. | length' output/wallets_report.json 2>/dev/null || echo "0")
            WALLETS_WITH_ACTIVITY=$(jq '[.[] | select(.has_defi_activity == true)] | length' output/wallets_report.json 2>/dev/null || echo "0")
            TOTAL_TX=$(jq '[.[] | .tx_count // 0] | add' output/wallets_report.json 2>/dev/null || echo "0")
          else
            NUM_WALLETS="0"
            WALLETS_WITH_ACTIVITY="0"
            TOTAL_TX="0"
          fi

          # çµ±è¨ˆ Alertsï¼ˆæª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨ï¼‰
          if [ -f "output/alerts.json" ]; then
            NUM_ALERTS=$(jq '. | length' output/alerts.json 2>/dev/null || echo "0")
            NUM_HIGH_ALERTS=$(jq '[.[] | select(.priority == "high")] | length' output/alerts.json 2>/dev/null || echo "0")
            NUM_MEDIUM_ALERTS=$(jq '[.[] | select(.priority == "medium")] | length' output/alerts.json 2>/dev/null || echo "0")
            NUM_LOW_ALERTS=$(jq '[.[] | select(.priority == "low")] | length' output/alerts.json 2>/dev/null || echo "0")
            TOP_ALERTS=$(jq -r '[.[] | select(.priority == "high") | .project] | .[0:3] | join(", ")' output/alerts.json 2>/dev/null || echo "")
          else
            NUM_ALERTS="0"
            NUM_HIGH_ALERTS="0"
            NUM_MEDIUM_ALERTS="0"
            NUM_LOW_ALERTS="0"
            TOP_ALERTS=""
          fi

          # è™•ç†ç©ºå­—ä¸²
          if [ -z "$TOP_ALERTS" ] || [ "$TOP_ALERTS" = "null" ]; then
            TOP_ALERTS="None"
          fi

          # å–å¾—å‰ 5 å€‹ active ç©ºæŠ•çš„å°ˆæ¡ˆåç¨±ï¼ˆå»é‡ï¼‰
          TOP_ACTIVE=$(jq -r '[.[] | select(.status == "active") | .project] | unique | .[0:5] | join(", ")' output/events_sources.json 2>/dev/null || echo "")
          if [ -z "$TOP_ACTIVE" ] || [ "$TOP_ACTIVE" = "null" ]; then
            TOP_ACTIVE="None"
          fi

          # å–å¾—å‰ 3 å€‹ upcoming ç©ºæŠ•çš„å°ˆæ¡ˆåç¨±
          TOP_UPCOMING=$(jq -r '[.[] | select(.status == "upcoming") | .project] | unique | .[0:3] | join(", ")' output/events_sources.json 2>/dev/null || echo "")
          if [ -z "$TOP_UPCOMING" ] || [ "$TOP_UPCOMING" = "null" ]; then
            TOP_UPCOMING="None"
          fi

          # æå–é«˜å„ªå…ˆç´šè­¦å ±çš„è©³ç´°ä¿¡æ¯ï¼ˆæœ€å¤š 3 å€‹ï¼‰
          HIGH_ALERT_DETAILS=""
          if [ -f "output/alerts.json" ] && [ "$NUM_HIGH_ALERTS" -gt 0 ]; then
            HIGH_ALERT_DETAILS=$(jq -r '[.[] | select(.priority == "high")] | .[0:3] | .[] | "â€¢ **\(.project)**: \(.type // "airdrop") - \(.notes // "Check details")"' output/alerts.json 2>/dev/null | head -3 || echo "")
          fi

          # æå–éŒ¢åŒ…æ´»å‹•æ‘˜è¦
          WALLET_SUMMARY=""
          if [ -f "output/wallets_report.json" ] && [ "$NUM_WALLETS" -gt 0 ]; then
            WALLET_SUMMARY=$(jq -r '.[] | "â€¢ \(.name) (\(.chain)): \(.tx_count) TX, DeFi: \(if .has_defi_activity then "Yes" else "No" end)"' output/wallets_report.json 2>/dev/null | head -5 || echo "")
          fi

          # è®€å– latest_report.md çš„é—œéµéƒ¨åˆ†ï¼ˆå¦‚æœæœ‰ï¼Œé™åˆ¶é•·åº¦é¿å…è¶…é Discord 2000 å­—ç¬¦é™åˆ¶ï¼‰
          REPORT_PREVIEW=""
          if [ -f "output/latest_report.md" ]; then
            REPORT_PREVIEW=$(head -c 300 output/latest_report.md 2>/dev/null | sed 's/```/`/g' | sed 's/\*\*/**/g' || echo "")
          fi

          # æ§‹å»ºè¨Šæ¯ä¸»é«”
          MESSAGE_BASE="âœ… **Airdrop Intel Pipeline Report**

          ğŸ“… **Execution Time:** \`$PIPELINE_TIME\` UTC

          ğŸ“Š **Events Summary:**
          â€¢ **Total Events:** \`$NUM_EVENTS\`
          â€¢ Active: \`$NUM_ACTIVE\` | Upcoming: \`$NUM_UPCOMING\` | Ended: \`$NUM_ENDED\` | Potential: \`$NUM_POTENTIAL\`

          ğŸ” **By Source:**
          â€¢ Airdrops.io: \`$NUM_AIRDROP_IO\` | CoinMarketCap: \`$NUM_CMC\` | ICOMarks: \`$NUM_ICOMARKS\` | AltcoinTrading: \`$NUM_ALTCOIN\`

          ğŸ’¼ **Wallets Analyzed:**
          â€¢ Checked: \`$NUM_WALLETS\` | With DeFi Activity: \`$WALLETS_WITH_ACTIVITY\` | Total TX: \`$TOTAL_TX\`"

          # æ·»åŠ éŒ¢åŒ…æ‘˜è¦ï¼ˆå¦‚æœæœ‰ï¼‰
          if [ -n "$WALLET_SUMMARY" ]; then
            MESSAGE_BASE="$MESSAGE_BASE

          $WALLET_SUMMARY"
          fi

          # æ·»åŠ è­¦å ±ä¿¡æ¯
          MESSAGE_BASE="$MESSAGE_BASE

          ğŸš¨ **Alerts Generated:** \`$NUM_ALERTS\` (High: \`$NUM_HIGH_ALERTS\` | Medium: \`$NUM_MEDIUM_ALERTS\` | Low: \`$NUM_LOW_ALERTS\`)"

          # æ·»åŠ é«˜å„ªå…ˆç´šè­¦å ±è©³æƒ…ï¼ˆå¦‚æœæœ‰ï¼‰
          if [ -n "$HIGH_ALERT_DETAILS" ]; then
            MESSAGE_BASE="$MESSAGE_BASE

          **High Priority Alerts:**
          $HIGH_ALERT_DETAILS"
          fi

          # æ·»åŠ ç©ºæŠ•åˆ—è¡¨
          MESSAGE_BASE="$MESSAGE_BASE

          ğŸ¯ **Top Active Airdrops:**
          $TOP_ACTIVE

          ğŸ”® **Upcoming Airdrops:**
          $TOP_UPCOMING"

          # æ·»åŠ å ±å‘Šé è¦½ï¼ˆå¦‚æœæœ‰ä¸”ä¸æœƒè¶…éé•·åº¦é™åˆ¶ï¼‰
          if [ -n "$REPORT_PREVIEW" ]; then
            MESSAGE_BASE="$MESSAGE_BASE

          ğŸ“„ **Report Preview:**
          \`\`\`
          ${REPORT_PREVIEW}...
          \`\`\`"
          fi

          # æ·»åŠ éˆæ¥
          MESSAGE="$MESSAGE_BASE

          ğŸ“ **Full Details:** [GitHub Actions Artifacts](https://github.com/${{ github.repository }}/actions)"

          # ä½¿ç”¨ jq æ­£ç¢ºè½‰ç¾© JSON å­—ä¸²
          ESCAPED_MESSAGE=$(echo "$MESSAGE" | jq -Rs .)

          # ç™¼é€åˆ° Discord
          curl -s -f -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\": $ESCAPED_MESSAGE}" \
            "$DISCORD_WEBHOOK_URL" || echo "Failed to send Discord message"

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-reports
          path: output/
          retention-days: 7
