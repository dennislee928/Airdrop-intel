name: Airdrop Intel Pipeline

on:
  schedule:
    - cron: "0 * * * *"   # ÊØèÂ∞èÊôÇÂü∑Ë°å‰∏ÄÊ¨°
  workflow_dispatch:       # ÂÖÅË®±ÊâãÂãïËß∏Áôº

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # ÂÆâË£ù jq Áî®Êñº JSON ËôïÁêÜ
          sudo apt-get update && sudo apt-get install -y jq

      - name: Run pipeline
        env:
          CMC_API_KEY: ${{ secrets.CMC_API_KEY }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python scripts/fetch_sources.py
          python scripts/check_wallets.py
          python scripts/aggregate.py
          python scripts/notify_github.py
          python scripts/notify_discord.py

      - name: Send mini-report to Discord
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # Ê™¢Êü•Ê™îÊ°àÊòØÂê¶Â≠òÂú®
          if [ ! -f "output/events_sources.json" ]; then
            echo "events_sources.json not found, skipping Discord report"
            exit 0
          fi

          # Ê™¢Êü• webhook URL
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "DISCORD_WEBHOOK_URL not set, skipping Discord report"
            exit 0
          fi

          PIPELINE_TIME="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

          # Áµ±Ë®à‰∫ã‰ª∂Á∏ΩÊï∏
          NUM_EVENTS=$(jq '. | length' output/events_sources.json 2>/dev/null || echo "0")

          # ÊåâÁãÄÊÖãÁµ±Ë®à
          NUM_ACTIVE=$(jq '[.[] | select(.status == "active")] | length' output/events_sources.json 2>/dev/null || echo "0")
          NUM_UPCOMING=$(jq '[.[] | select(.status == "upcoming")] | length' output/events_sources.json 2>/dev/null || echo "0")
          NUM_ENDED=$(jq '[.[] | select(.status == "ended")] | length' output/events_sources.json 2>/dev/null || echo "0")
          NUM_POTENTIAL=$(jq '[.[] | select(.status == "potential")] | length' output/events_sources.json 2>/dev/null || echo "0")

          # Êåâ‰æÜÊ∫êÁµ±Ë®à
          NUM_AIRDROP_IO=$(jq '[.[] | select(.source == "airdrops_io")] | length' output/events_sources.json 2>/dev/null || echo "0")
          NUM_CMC=$(jq '[.[] | select(.source == "cmc_airdrops")] | length' output/events_sources.json 2>/dev/null || echo "0")
          NUM_ICOMARKS=$(jq '[.[] | select(.source == "icomarks_airdrops")] | length' output/events_sources.json 2>/dev/null || echo "0")
          NUM_ALTCOIN=$(jq '[.[] | select(.source == "altcointrading_airdrops")] | length' output/events_sources.json 2>/dev/null || echo "0")
          NUM_CHECKLIST=$(jq '[.[] | select(.source == "airdrop_checklist")] | length' output/events_sources.json 2>/dev/null || echo "0")
          NUM_ALERT=$(jq '[.[] | select(.source == "airdropsalert")] | length' output/events_sources.json 2>/dev/null || echo "0")

          # Áµ±Ë®àÈå¢ÂåÖÔºàÊ™¢Êü•Ê™îÊ°àÊòØÂê¶Â≠òÂú®Ôºâ
          if [ -f "output/wallets_report.json" ]; then
            NUM_WALLETS=$(jq '. | length' output/wallets_report.json 2>/dev/null || echo "0")
            WALLETS_WITH_ACTIVITY=$(jq '[.[] | select(.has_defi_activity == true)] | length' output/wallets_report.json 2>/dev/null || echo "0")
            TOTAL_TX=$(jq '[.[] | .tx_count // 0] | add' output/wallets_report.json 2>/dev/null || echo "0")
          else
            NUM_WALLETS="0"
            WALLETS_WITH_ACTIVITY="0"
            TOTAL_TX="0"
          fi

          # Áµ±Ë®à AlertsÔºàÊ™¢Êü•Ê™îÊ°àÊòØÂê¶Â≠òÂú®Ôºâ
          if [ -f "output/alerts.json" ]; then
            NUM_ALERTS=$(jq '. | length' output/alerts.json 2>/dev/null || echo "0")
            NUM_HIGH_ALERTS=$(jq '[.[] | select(.priority == "high")] | length' output/alerts.json 2>/dev/null || echo "0")
            NUM_MEDIUM_ALERTS=$(jq '[.[] | select(.priority == "medium")] | length' output/alerts.json 2>/dev/null || echo "0")
            NUM_LOW_ALERTS=$(jq '[.[] | select(.priority == "low")] | length' output/alerts.json 2>/dev/null || echo "0")
            TOP_ALERTS=$(jq -r '[.[] | select(.priority == "high") | .project] | .[0:3] | join(", ")' output/alerts.json 2>/dev/null || echo "")
          else
            NUM_ALERTS="0"
            NUM_HIGH_ALERTS="0"
            NUM_MEDIUM_ALERTS="0"
            NUM_LOW_ALERTS="0"
            TOP_ALERTS=""
          fi

          # ËôïÁêÜÁ©∫Â≠ó‰∏≤
          if [ -z "$TOP_ALERTS" ] || [ "$TOP_ALERTS" = "null" ]; then
            TOP_ALERTS="None"
          fi

          # ÂèñÂæóÂâç 5 ÂÄã active Á©∫ÊäïÁöÑÂ∞àÊ°àÂêçÁ®±ÔºàÂéªÈáçÔºâ
          TOP_ACTIVE=$(jq -r '[.[] | select(.status == "active") | .project] | unique | .[0:5] | join(", ")' output/events_sources.json 2>/dev/null || echo "")
          if [ -z "$TOP_ACTIVE" ] || [ "$TOP_ACTIVE" = "null" ]; then
            TOP_ACTIVE="None"
          fi

          # ÂèñÂæóÂâç 3 ÂÄã upcoming Á©∫ÊäïÁöÑÂ∞àÊ°àÂêçÁ®±
          TOP_UPCOMING=$(jq -r '[.[] | select(.status == "upcoming") | .project] | unique | .[0:3] | join(", ")' output/events_sources.json 2>/dev/null || echo "")
          if [ -z "$TOP_UPCOMING" ] || [ "$TOP_UPCOMING" = "null" ]; then
            TOP_UPCOMING="None"
          fi

          # ÊèêÂèñÈ´òÂÑ™ÂÖàÁ¥öË≠¶Â†±ÁöÑË©≥Á¥∞‰ø°ÊÅØÔºàÊúÄÂ§ö 3 ÂÄãÔºâ
          HIGH_ALERT_DETAILS=""
          if [ -f "output/alerts.json" ] && [ "$NUM_HIGH_ALERTS" -gt 0 ]; then
            HIGH_ALERT_DETAILS=$(jq -r '[.[] | select(.priority == "high")] | .[0:3] | .[] | "‚Ä¢ **\(.project)**: \(.type // "airdrop") - \(.notes // "Check details")"' output/alerts.json 2>/dev/null | head -3 | tr '\n' '\n' || echo "")
          fi

          # ÊèêÂèñÈå¢ÂåÖÊ¥ªÂãïÊëòË¶Å
          WALLET_SUMMARY=""
          if [ -f "output/wallets_report.json" ] && [ "$NUM_WALLETS" -gt 0 ]; then
            WALLET_SUMMARY=$(jq -r '.[] | "‚Ä¢ \(.name) (\(.chain)): \(.tx_count) TX, DeFi: \(if .has_defi_activity then "Yes" else "No" end)"' output/wallets_report.json 2>/dev/null | head -5 | tr '\n' '\n' || echo "")
          fi

          # ËÆÄÂèñ latest_report.md ÁöÑÈóúÈçµÈÉ®ÂàÜÔºàÂ¶ÇÊûúÊúâÔºâ
          REPORT_PREVIEW=""
          if [ -f "output/latest_report.md" ]; then
            # ÊèêÂèñÂâç 500 Â≠óÁ¨¶‰ΩúÁÇ∫È†êË¶Ω
            REPORT_PREVIEW=$(head -c 500 output/latest_report.md 2>/dev/null | sed 's/```/`/g' || echo "")
            if [ ${#REPORT_PREVIEW} -gt 0 ]; then
              REPORT_PREVIEW="\n\nüìÑ **Report Preview:**\n\`\`\`\n${REPORT_PREVIEW}...\n\`\`\`"
            fi
          fi

          # Âª∫Á´ã Discord Ë®äÊÅØÔºà‰ΩøÁî® Markdown Ê†ºÂºèÔºâ
          MESSAGE="‚úÖ **Airdrop Intel Pipeline Report**

          üìÖ **Execution Time:** \`$PIPELINE_TIME\` UTC

          üìä **Events Summary:**
          ‚Ä¢ **Total Events:** \`$NUM_EVENTS\`
          ‚Ä¢ Active: \`$NUM_ACTIVE\` | Upcoming: \`$NUM_UPCOMING\` | Ended: \`$NUM_ENDED\` | Potential: \`$NUM_POTENTIAL\`

          üîç **By Source:**
          ‚Ä¢ Airdrops.io: \`$NUM_AIRDROP_IO\` | CoinMarketCap: \`$NUM_CMC\` | ICOMarks: \`$NUM_ICOMARKS\` | AltcoinTrading: \`$NUM_ALTCOIN\`

          üíº **Wallets Analyzed:**
          ‚Ä¢ Checked: \`$NUM_WALLETS\` | With DeFi Activity: \`$WALLETS_WITH_ACTIVITY\` | Total TX: \`$TOTAL_TX\`
          ${WALLET_SUMMARY:+$'\n'$WALLET_SUMMARY}

          üö® **Alerts Generated:** \`$NUM_ALERTS\` (High: \`$NUM_HIGH_ALERTS\` | Medium: \`$NUM_MEDIUM_ALERTS\` | Low: \`$NUM_LOW_ALERTS\`)
          ${HIGH_ALERT_DETAILS:+$'\n'**High Priority Alerts:**$'\n'$HIGH_ALERT_DETAILS}

          üéØ **Top Active Airdrops:**
          $TOP_ACTIVE

          üîÆ **Upcoming Airdrops:**
          $TOP_UPCOMING
          ${REPORT_PREVIEW}

          üìé **Full Details:** [GitHub Actions Artifacts](https://github.com/${{ github.repository }}/actions)"

          # ‰ΩøÁî® jq Ê≠£Á¢∫ËΩâÁæ© JSON Â≠ó‰∏≤
          ESCAPED_MESSAGE=$(echo "$MESSAGE" | jq -Rs .)

          # ÁôºÈÄÅÂà∞ Discord
          curl -s -f -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\": $ESCAPED_MESSAGE}" \
            "$DISCORD_WEBHOOK_URL" || echo "Failed to send Discord message"

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-reports
          path: output/
          retention-days: 7
